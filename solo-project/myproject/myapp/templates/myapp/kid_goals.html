<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Goals</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
body {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    background: linear-gradient(135deg, #aee1f9 0%, #ffd6e0 100%);
    margin: 0;
    padding: 0;
    position: relative;
    overflow-x: hidden;
}

/* Navbar */
.navbar {
    background-color: #fdc1cc;
    border-radius: 15px;
    margin: 10px;
    padding: 10px 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.navbar-brand {
    font-size: 1.5rem;
    color: #fff;
    display: flex;
    align-items: center;
}
.profile-pic {
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 8px;
}

/* Cute Buttons (general) */
.btn-cute {
    background: #FFB6C1;
    border-radius: 25px;
    font-weight: bold;
    border: none;
    padding: 10px 20px;
    transition: all 0.3s;
    color: #fff;
    margin-left: 8px;
}
.btn-cute:hover {
    background: #FF69B4;
    transform: scale(1.05);
    color: #fff;
}

/* Goals */
.container { max-width:900px; padding-bottom:50px; }
h2 { color:#FF69B4; text-align:center; margin-top:20px; }
.goals-grid { display:flex; flex-wrap:wrap; justify-content:center; gap:15px; margin-top:20px; }
.goal-card { background:#fff3f8; border-radius:25px; padding:15px; width:220px; box-shadow:0 6px 15px rgba(0,0,0,0.1); position:relative; }
.goal-card.completed { border:2px solid #FFB6C1; box-shadow:0 0 20px rgba(255,182,193,0.5), 0 0 40px rgba(255,182,193,0.3); }
.goal-card.add-new { background:#ffd6e0; border:2px dashed #FFB6C1; text-align:center; }
.goal-title { display:block; text-align:center; font-size:1rem; font-weight:bold; margin-bottom:5px; }
.goal-completed-msg { color:#FF69B4; font-weight:bold; text-align:center; font-size:1.1rem; margin-bottom:5px; text-shadow:0 0 5px #FFB6C1, 0 0 10px #FF99CC; }
input, select { border-radius:12px; padding:6px 10px; border:1px solid #ccc; margin-bottom:6px; width:100%; text-align:center; }
form { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
.progress { height:18px; border-radius:12px; background-color:#f1f1f1; margin-top:6px; }
.progress-bar { background-color:#FF69B4; color:white; font-weight:bold; text-align:center; font-size:0.9rem; }
.star { position:absolute; width:12px; height:12px; background:#FFB6C1; clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%); opacity:0; pointer-events:none; animation:sparkle 1s infinite; }
@keyframes sparkle { 0%,100%{opacity:0; transform:scale(0.3) rotate(0deg);} 50%{opacity:1; transform:scale(1) rotate(360deg);} }

.text-success { color:green; }
.text-danger { color:red; }
.text-warning { color:orange; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar shadow-sm">
  <span class="navbar-brand d-flex align-items-center">
    <img src="https://img.icons8.com/doodle/512/bubbles-powerpuff-girls.png" alt="profile" class="profile-pic">
    Hello, {{ kid.user_name }} 
  </span>
  <div>
    <a href="{% url 'kid_dashboard' %}" class="btn-cute">⬅ Dashboard</a>
    <a href="{% url 'logout' %}" class="btn-cute"><i class="fa fa-sign-out-alt"></i> Logout</a>
  </div>
</nav>

<div class="container py-5">
  <h2>My Savings Goals</h2>
  <p id="balance" style="text-align:center; font-weight:bold;">Balance: ${{ user.balance }}</p>

  <div class="goals-grid">
    <!-- Add New Goal Card -->
    <div class="goal-card add-new">
      <h3>Create New Goal</h3>
      <form action="{% url 'add_goal' %}" method="POST">
        {% csrf_token %}
        <input type="text" name="name" placeholder="Goal Name" required>
        <input type="number" name="target_amount" step="0.01" placeholder="Target Amount" required>
        <button type="submit" class="btn-cute">Add Goal</button>
      </form>
    </div>

    <!-- Loop through goals -->
    {% for goal in goals %}
      <div class="goal-card {% if goal.saved_amount >= goal.target_amount %}completed{% endif %}" id="goal-{{ goal.id }}">
        <span class="goal-title">{{ goal.name }}</span>
        <p style="text-align:center;">Saved: ${{ goal.saved_amount }} / ${{ goal.target_amount }}</p>
        <div class="progress">
          <div class="progress-bar" style="width: {{ goal.progress }}%;">{{ goal.progress }}%</div>
        </div>

        {% if goal.saved_amount >= goal.target_amount %}
          <div class="goal-completed-msg">⭐ Goal Achieved! ⭐</div>
          <div class="stars-container"></div>
        {% else %}
          <form class="goal-contribution-form" data-goal-id="{{ goal.id }}">
            {% csrf_token %}
            <input type="hidden" name="type" value="Goal Contribution">
            <input type="hidden" name="goal_id" value="{{ goal.id }}">
            <input type="number" name="amount" step="0.01" placeholder="Amount to add" required>
            <button type="submit" class="btn-cute">Add to Goal</button>
          </form>
          <p id="goal-msg-{{ goal.id }}" style="text-align:center; font-weight:bold;"></p>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        });
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

function updateBalance(newBalance) {
    const balanceEl = document.getElementById("balance");
    if(balanceEl) balanceEl.innerText = "Balance: $" + parseFloat(newBalance).toFixed(2);
}

function triggerGoalAnimation(goalId) {
    const card = document.getElementById(`goal-${goalId}`);
    if(!card) return;
    card.classList.add("completed");
    const form = card.querySelector("form.goal-contribution-form"); if(form) form.remove();
    const msgEl = document.getElementById(`goal-msg-${goalId}`); if(msgEl) msgEl.remove();
    const completedText = document.createElement("div"); completedText.classList.add("goal-completed-msg");
    completedText.innerText = "⭐ Goal Achieved! ⭐"; card.appendChild(completedText);
    const container = document.createElement("div"); container.classList.add("stars-container"); card.appendChild(container);
    for(let i=0;i<12;i++){ const star = document.createElement("div"); star.classList.add("star"); star.style.left = Math.random()*80 + "%"; star.style.top = Math.random()*60 + "%"; star.style.animationDelay = (Math.random()*2) + "s"; container.appendChild(star); }
}

document.querySelectorAll(".goal-contribution-form").forEach(form => {
    form.addEventListener("submit", function(e){
        e.preventDefault();
        const goalId = this.dataset.goalId;
        const msgEl = document.getElementById(`goal-msg-${goalId}`);
        const formData = new FormData(this);
        fetch("{% url 'make_transaction' %}", { method:"POST", headers: {"X-CSRFToken": csrftoken}, body: formData })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                updateBalance(data.new_balance);
                msgEl.innerText = "✅ " + data.message; msgEl.className = "text-success";
                const progressBar = document.querySelector(`#goal-${goalId} .progress-bar`);
                const savedText = document.querySelector(`#goal-${goalId} p`);
                if(progressBar){ progressBar.style.width = data.goal_progress + "%"; progressBar.innerText = data.goal_progress + "%"; }
                if(savedText){ savedText.innerText = `Saved: $${data.goal_saved} / ${savedText.innerText.split("/")[1].trim()}`; }
                if(data.goal_progress >= 100){ triggerGoalAnimation(goalId); }
            } else { msgEl.innerText = "❌ " + data.error; msgEl.className = "text-danger"; }
        })
        .catch(err => { msgEl.innerText = "⚠️ Something went wrong!"; msgEl.className = "text-warning"; console.error(err); });
    });
});

document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".goal-card.completed").forEach(card => {
        const container = card.querySelector(".stars-container") || (()=>{ const c = document.createElement("div"); c.classList.add("stars-container"); card.appendChild(c); return c; })();
        for(let i=0;i<12;i++){ const star = document.createElement("div"); star.classList.add("star"); star.style.left = Math.random()*80 + "%"; star.style.top = Math.random()*60 + "%"; star.style.animationDelay = (Math.random()*2) + "s"; container.appendChild(star); }
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
